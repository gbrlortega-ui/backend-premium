<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sa√∫de ‚Ä¢ IMC & Calorias</title>
  <style>
    :root {
      --bg1: #0f172a;
      --bg2: #1e293b;
      --accent: #38bdf8;
      --accent-hover: #0ea5e9;
      --text-main: #f8fafc;
      --text-dim: #94a3b8;
      --card-bg: rgba(30,41,59,0.8);
      --radius-lg: 16px;
      --ok-bg: rgba(16,185,129,0.12);
      --ok-border: rgba(16,185,129,0.4);
      --ok-text: #6ee7b7;
      --off-bg: rgba(239,68,68,0.12);
      --off-border: rgba(239,68,68,0.4);
      --off-text: #f87171;
      --border-color: rgba(148,163,184,0.2);
    }

    * {
      box-sizing: border-box;
      font-family: system-ui, "Inter", sans-serif;
    }

    body {
      margin: 0;
      min-height: 100vh;
      background: radial-gradient(circle at 20% 20%, #1e3a8a 0%, #0f172a 60%);
      color: var(--text-main);
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding: 2rem 1rem 6rem;
    }

    .app {
      background: var(--card-bg);
      backdrop-filter: blur(16px);
      width: 100%;
      max-width: 380px;
      border-radius: var(--radius-lg);
      box-shadow: 0 30px 80px rgba(0,0,0,0.8);
      border: 1px solid rgba(148,163,184,0.2);
      padding: 24px;
      position: relative;
    }

    h1 {
      font-size: 1.1rem;
      font-weight: 600;
      margin: 0 0 1rem;
      display: flex;
      justify-content: space-between;
      align-items: baseline;
    }

    h1 span {
      font-size: .7rem;
      color: var(--accent);
    }

    .status-box {
      font-size: .7rem;
      font-weight: 500;
      border-radius: 10px;
      padding: 8px 10px;
      border: 1px solid;
      margin-bottom: 1rem;
    }

    .status-ok {
      background: var(--ok-bg);
      border-color: var(--ok-border);
      color: var(--ok-text);
    }

    .status-off {
      background: var(--off-bg);
      border-color: var(--off-border);
      color: var(--off-text);
    }

    .mini-label {
      font-size: .7rem;
      color: var(--text-dim);
      margin-bottom: 4px;
      font-weight: 500;
    }

    input,
    select {
      width: 100%;
      background: var(--bg2);
      color: var(--text-main);
      border: 1px solid rgba(148,163,184,0.3);
      border-radius: 10px;
      padding: 10px 12px;
      font-size: .9rem;
      outline: none;
    }

    input:focus,
    select:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(56,189,248,0.2);
    }

    .btn-main {
      background: var(--accent);
      color: #0f172a;
      padding: 10px 12px;
      border: 0;
      border-radius: 10px;
      font-weight: 600;
      cursor: pointer;
      width: 100%;
    }

    .btn-alt {
      background: transparent;
      color: var(--text-main);
      border: 1px solid rgba(148,163,184,0.4);
      padding: 10px 12px;
      border-radius: 10px;
      font-weight: 600;
      cursor: pointer;
      width: 100%;
      margin-top: 8px;
    }

    .btn-main:hover {
      background: var(--accent-hover);
    }

    .btn-alt:hover {
      background: rgba(148,163,184,0.12);
    }

    .calc-btn {
      width: 100%;
      background: var(--accent);
      color: #0f172a;
      border: 0;
      border-radius: 10px;
      padding: 12px 16px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      margin-top: 8px;
    }

    .calc-btn:hover {
      background: var(--accent-hover);
    }

    .results-card {
      background: var(--bg2);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border-color);
      padding: 16px 20px;
      margin-top: 20px;
      display: none;
    }

    .section-title {
      font-size: .8rem;
      font-weight: 600;
      color: var(--text-dim);
      text-transform: uppercase;
      margin-bottom: 8px;
    }

    .result-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 6px;
      font-size: .9rem;
    }

    .result-row .label {
      color: var(--text-dim);
    }

    .result-row .value {
      color: var(--text-main);
      font-weight: 500;
    }

    .highlight {
      text-align: center;
      color: var(--accent);
      font-weight: 600;
      margin-top: 12px;
    }

    .ebook-btn,
    .dieta-btn {
      display: block;
      width: 100%;
      text-align: center;
      padding: 12px;
      font-weight: 600;
      border-radius: 10px;
      margin-top: 12px;
    }

    .ebook-btn {
      background: linear-gradient(135deg, #f97316, #f59e0b);
      color: #fff;
      text-decoration: none;
    }

    .dieta-btn {
      background: linear-gradient(135deg, #34d399, #10b981);
      color: #0f172a;
      border: 0;
    }

    .dieta-btn[disabled] {
      opacity: .4;
      cursor: not-allowed;
      filter: grayscale(1);
    }

    .footer-note {
      text-align: center;
      font-size: .7rem;
      color: var(--text-dim);
      margin-top: 16px;
    }

    /* Modal Pagamento */
    .paywall-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.7);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      padding: 1.5rem;
    }

    .paywall-box {
      background: #1e293b;
      border: 1px solid rgba(148,163,184,0.4);
      border-radius: 16px;
      max-width: 360px;
      width: 100%;
      padding: 20px;
      color: #f8fafc;
    }

    .mp-btn {
      display: block;
      text-align: center;
      background: linear-gradient(135deg,#34d399,#10b981);
      color: #0f172a;
      font-weight: 600;
      padding: 12px;
      border-radius: 10px;
      text-decoration: none;
      box-shadow: 0 15px 40px rgba(0,0,0,0.6);
    }

    .paywall-close {
      width: 100%;
      background: transparent;
      border: 0;
      color: #94a3b8;
      font-size: .8rem;
      margin-top: 12px;
      cursor: pointer;
      text-align: center;
    }
  </style>
</head>
<body>

  <!-- MODAL: Mercado Pago -->
  <div id="paywallModal" class="paywall-overlay">
    <div class="paywall-box">
      <h3 style="margin:0 0 6px;">Dieta Premium</h3>
      <p style="font-size:.85rem;color:#94a3b8;line-height:1.4;">
        Pagamento √∫nico. Ap√≥s aprova√ß√£o, seu acesso premium ser√° liberado automaticamente.
      </p>

      <!-- Link direto de pagamento Mercado Pago -->
      <a id="checkoutMP" class="mp-btn" href="https://mpago.la/2jQUXM9" target="_blank">
        üí≥ Pagar agora com Mercado Pago
      </a>

      <p style="font-size:.75rem;color:#94a3b8;text-align:center;margin-top:8px;">
        Depois de pagar, basta fazer login novamente para liberar o acesso premium.
      </p>

      <button id="btnFecharModal" class="paywall-close">Fechar</button>
    </div>
  </div>

  <!-- TELA LOGIN -->
  <section id="telaLogin" class="app">
    <h1>
      Sa√∫de ‚Ä¢ IMC & Calorias
      <span>v1.7</span>
    </h1>

    <div style="text-align:center;margin-bottom:1rem;">
      <strong>Bem-vindo!</strong><br/>
      Crie sua conta gr√°tis e tenha c√°lculo de IMC,<br/>
      gasto cal√≥rico e gere sua dieta personalizada.
    </div>

    <div id="loginStatus" class="status-box status-off">Desconectado</div>

    <div>
      <div class="mini-label">E-mail</div>
      <input id="emailLogin" type="email" placeholder="voce@exemplo.com"/>

      <div class="mini-label" style="margin-top:8px;">Senha</div>
      <input id="senhaLogin" type="password" placeholder="m√≠n. 6 d√≠gitos"/>

      <button class="btn-main" id="btnCadastrar" style="margin-top:12px;">Criar conta</button>
      <button class="btn-alt" id="btnLogin">Entrar</button>
    </div>

    <div class="footer-note" style="margin-top:1rem;">
      Ao entrar, voc√™ desbloqueia a calculadora<br/>e pode gerar sua dieta personalizada.
    </div>
  </section>

  <!-- TELA APP -->
  <section id="telaApp" class="app" style="display:none;">
    <h1>
      Sa√∫de ‚Ä¢ IMC & Calorias
      <span>v1.7</span>
    </h1>

    <div style="display:flex;justify-content:space-between;align-items:center;">
      <div id="loginStatusApp" class="status-box status-off">Desconectado</div>
      <button class="btn-alt" id="btnLogout" style="width:auto;">Sair</button>
    </div>

    <div style="margin-top:8px;">
      <div class="mini-label">Sexo</div>
      <select id="sexo">
        <option value="masc">Masculino</option>
        <option value="fem">Feminino</option>
      </select>

      <div class="mini-label" style="margin-top:8px;">Idade (anos)</div>
      <input type="number" id="idade" placeholder="ex: 28" />

      <div class="mini-label" style="margin-top:8px;">Peso (kg)</div>
      <input type="number" id="peso" step="0.1" placeholder="ex: 72.5" />

      <div class="mini-label" style="margin-top:8px;">Altura (cm)</div>
      <input type="number" id="altura" step="0.1" placeholder="ex: 175" />

      <div class="mini-label" style="margin-top:8px;">N√≠vel de atividade f√≠sica</div>
      <select id="atividade">
        <option value="1.2">Sedent√°rio</option>
        <option value="1.375">Leve (1-3x/semana)</option>
        <option value="1.55">Moderado (3-5x/semana)</option>
        <option value="1.725">Intenso (6-7x/semana)</option>
      </select>

      <button class="calc-btn" id="calcBtn">Calcular IMC e Calorias</button>
    </div>

    <div class="results-card" id="resultadoArea">
      <div class="section-title">IMC e Calorias</div>

      <div class="result-row">
        <div class="label">IMC</div>
        <div class="value" id="imcValor">--</div>
      </div>

      <div class="result-row">
        <div class="label">Classifica√ß√£o</div>
        <div class="value" id="imcClassificacao">--</div>
      </div>

      <div class="result-row">
        <div class="label">Manuten√ß√£o</div>
        <div class="value" id="kcalManutencao">-- kcal/dia</div>
      </div>

      <div class="result-row">
        <div class="label">Perda (~0,5 kg/sem)</div>
        <div class="value" id="kcalCorte">-- kcal/dia</div>
      </div>

      <div class="result-row">
        <div class="label">Ganho</div>
        <div class="value" id="kcalSuperavit">-- kcal/dia</div>
      </div>

      <div class="highlight" id="resumoMensagem"></div>

      <a class="ebook-btn" href="https://go.hotmart.com/X102584266R" target="_blank">
        üí™ Adquira seu E-book
      </a>

      <button class="dieta-btn" id="dietaBtn" disabled>
        üîí Fa√ßa login para gerar sua dieta
      </button>

      <div class="footer-note">
        Acesso premium: pagamento √∫nico via Mercado Pago.
      </div>
    </div>
  </section>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged,
      createUserWithEmailAndPassword,
      signInWithEmailAndPassword,
      signOut
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

    import {
      getFirestore,
      doc,
      getDoc
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyBS5eGv77GcOHL7Z02sGETCaj4YNz6H3uE",
      authDomain: "emagreca-com-saude-4528d.firebaseapp.com",
      projectId: "emagreca-com-saude-4528d",
      storageBucket: "emagreca-com-saude-4528d.firebasestorage.app",
      messagingSenderId: "373054047338",
      appId: "1:373054047338:web:f7aa9db304a04a6877f613",
      measurementId: "G-S5HPSPH3ZX"
    };

    // Inicializa Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    // DOM refs
    const telaLoginEl        = document.getElementById("telaLogin");
    const telaAppEl          = document.getElementById("telaApp");

    const loginStatusEl      = document.getElementById("loginStatus");
    const loginStatusAppEl   = document.getElementById("loginStatusApp");

    const emailLoginEl       = document.getElementById("emailLogin");
    const senhaLoginEl       = document.getElementById("senhaLogin");

    const btnCadastrarEl     = document.getElementById("btnCadastrar");
    const btnLoginEl         = document.getElementById("btnLogin");
    const btnLogoutEl        = document.getElementById("btnLogout");

    const sexoEl             = document.getElementById("sexo");
    const idadeEl            = document.getElementById("idade");
    const pesoEl             = document.getElementById("peso");
    const alturaEl           = document.getElementById("altura");
    const atividadeEl        = document.getElementById("atividade");
    const calcBtn            = document.getElementById("calcBtn");

    const resultadoArea      = document.getElementById("resultadoArea");
    const imcValorEl         = document.getElementById("imcValor");
    const imcClassificacaoEl = document.getElementById("imcClassificacao");
    const kcalManutencaoEl   = document.getElementById("kcalManutencao");
    const kcalCorteEl        = document.getElementById("kcalCorte");
    const kcalSuperavitEl    = document.getElementById("kcalSuperavit");
    const resumoMensagemEl   = document.getElementById("resumoMensagem");

    const dietaBtnEl         = document.getElementById("dietaBtn");

    const paywallModalEl     = document.getElementById("paywallModal");
    const btnFecharModalEl   = document.getElementById("btnFecharModal");

    // Estado
    let USER_LOGADO = false;
    let PREMIUM_LIBERADO = false;

    // Utils de UI
    function abrirPaywall() {
      paywallModalEl.style.display = "flex";
    }

    function fecharPaywall() {
      paywallModalEl.style.display = "none";
    }

    btnFecharModalEl.addEventListener("click", fecharPaywall);

    function trocarTela(logado) {
      telaLoginEl.style.display = logado ? "none" : "block";
      telaAppEl.style.display   = logado ? "block" : "none";
    }

    function classificarIMC(imc) {
      if (imc < 18.5) return "Abaixo";
      else if (imc < 24.9) return "Normal";
      else if (imc < 29.9) return "Sobrepeso";
      else if (imc < 34.9) return "Obesidade I";
      else if (imc < 39.9) return "Obesidade II";
      else return "Obesidade III";
    }

    function calcularTMB(sexo, peso, alturaCm, idade) {
      // F√≥rmula de Mifflin-St Jeor
      if (sexo === "masc") {
        return 10 * peso + 6.25 * alturaCm - 5 * idade + 5;
      } else {
        return 10 * peso + 6.25 * alturaCm - 5 * idade - 161;
      }
    }

    function atualizarBotaoDieta() {
      dietaBtnEl.disabled = false;

      if (!USER_LOGADO) {
        dietaBtnEl.textContent = "üîí Fa√ßa login";
        return;
      }

      if (PREMIUM_LIBERADO) {
        dietaBtnEl.textContent = "üî• Gere agora sua dieta";
      } else {
        dietaBtnEl.textContent = "üí≥ Desbloquear dieta (premium)";
      }
    }

    // Observa login/logout
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        USER_LOGADO = true;

        loginStatusEl.textContent = "Logado: " + user.email;
        loginStatusEl.classList.remove("status-off");
        loginStatusEl.classList.add("status-ok");

        loginStatusAppEl.textContent = "Logado: " + user.email;
        loginStatusAppEl.classList.remove("status-off");
        loginStatusAppEl.classList.add("status-ok");

        trocarTela(true);

        // checar premium no Firestore
        try {
          const id = user.email
            .replace(/[^a-zA-Z0-9._-]/g, "_")
            .toLowerCase();

          const snap = await getDoc(doc(db, "usuarios", id));

          PREMIUM_LIBERADO = snap.exists() && snap.data().premium === true;
        } catch (e) {
          PREMIUM_LIBERADO = false;
        }

        atualizarBotaoDieta();
      } else {
        USER_LOGADO = false;
        PREMIUM_LIBERADO = false;

        loginStatusEl.textContent = "Desconectado";
        loginStatusEl.classList.remove("status-ok");
        loginStatusEl.classList.add("status-off");

        loginStatusAppEl.textContent = "Desconectado";
        loginStatusAppEl.classList.remove("status-ok");
        loginStatusAppEl.classList.add("status-off");

        trocarTela(false);
        atualizarBotaoDieta();
      }
    });

    // Criar conta
    btnCadastrarEl.addEventListener("click", async () => {
      try {
        await createUserWithEmailAndPassword(auth, emailLoginEl.value, senhaLoginEl.value);
        alert("Conta criada com sucesso ‚úÖ");
      } catch (err) {
        alert("Erro ao cadastrar: " + err.message);
      }
    });

    // Login
    btnLoginEl.addEventListener("click", async () => {
      try {
        await signInWithEmailAndPassword(auth, emailLoginEl.value, senhaLoginEl.value);
        alert("Login feito ‚úÖ");
      } catch (err) {
        alert("Erro ao entrar: " + err.message);
      }
    });

    // Logout
    btnLogoutEl.addEventListener("click", async () => {
      await signOut(auth);
      alert("Saiu da conta");
    });

    // C√°lculo IMC e kcal
    calcBtn.addEventListener("click", () => {
      const sexo       = sexoEl.value;
      const idade      = parseInt(idadeEl.value);
      const peso       = parseFloat(pesoEl.value);
      const alturaCm   = parseFloat(alturaEl.value);
      const atividade  = parseFloat(atividadeEl.value);

      if (!sexo || !idade || !peso || !alturaCm || !atividade) {
        alert("Por favor, preencha todos os campos corretamente!");
        return;
      }

      const alturaM = alturaCm / 100;
      const imc = peso / (alturaM * alturaM);
      const classificacao = classificarIMC(imc);

      const tmb = calcularTMB(sexo, peso, alturaCm, idade);
      const gastoManutencao = tmb * atividade;
      const cortar500 = gastoManutencao - 500;
      const aumentar500 = gastoManutencao + 500;

      imcValorEl.textContent           = imc.toFixed(2);
      imcClassificacaoEl.textContent   = classificacao;
      kcalManutencaoEl.textContent     = Math.round(gastoManutencao) + " kcal/dia";
      kcalCorteEl.textContent          = Math.round(cortar500) + " kcal/dia";
      kcalSuperavitEl.textContent      = Math.round(aumentar500) + " kcal/dia";

      let msg = "";
      if (classificacao.includes("Obesidade") || classificacao.includes("Sobrepeso")) {
        msg = "üî• D√©ficit de ~500 kcal/dia acelera perda de peso de forma segura.";
      } else if (classificacao.includes("Abaixo")) {
        msg = "üçΩÔ∏è Super√°vit leve ajuda a recuperar massa e energia.";
      } else {
        msg = "‚úÖ Mantenha consist√™ncia e ajuste leve de calorias.";
      }
      resumoMensagemEl.textContent = msg;

      resultadoArea.style.display = "block";

      // salva metas no sessionStorage pra montar dieta depois
      sessionStorage.setItem("nutriMaintKcal", Math.round(gastoManutencao));
      sessionStorage.setItem("nutriCutKcal", Math.round(cortar500));
      sessionStorage.setItem("nutriBulkKcal", Math.round(aumentar500));

      // sugerir objetivo autom√°tico
      let objetivoSugerido = "manutencao";
      if (classificacao.includes("Obesidade") || classificacao.includes("Sobrepeso")) {
        objetivoSugerido = "perda";
      } else if (classificacao.includes("Abaixo")) {
        objetivoSugerido = "ganho";
      }
      sessionStorage.setItem("nutriGoal", objetivoSugerido);
    });

    // Clique no bot√£o "Gerar dieta"
    dietaBtnEl.addEventListener("click", () => {
      if (!USER_LOGADO) {
        alert("Fa√ßa login primeiro para continuar üôå");
        return;
      }

      if (!PREMIUM_LIBERADO) {
        // n√£o √© premium ainda -> abre modal Mercado Pago
        abrirPaywall();
        return;
      }

      // premium TRUE -> segue pra dieta.html levando objetivo e kcal sugerida
      const sugerido = sessionStorage.getItem("nutriGoal") || "manutencao";

      const cutKcal   = sessionStorage.getItem("nutriCutKcal");
      const bulkKcal  = sessionStorage.getItem("nutriBulkKcal");
      const maintKcal = sessionStorage.getItem("nutriMaintKcal");

      let kcalParaMostrar = maintKcal;
      if (sugerido === "perda") kcalParaMostrar = cutKcal;
      if (sugerido === "ganho") kcalParaMostrar = bulkKcal;

      sessionStorage.setItem("nutriTargetKcal", kcalParaMostrar);

      const params = new URLSearchParams({
        goal: sugerido,
        targetKcal: kcalParaMostrar
      });

      window.location.href = "dieta.html?" + params.toString();
    });

  </script>
</body>
</html>
