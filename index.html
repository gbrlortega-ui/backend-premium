<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import {
    getAuth,
    onAuthStateChanged,
    createUserWithEmailAndPassword,
    signInWithEmailAndPassword,
    signOut
  } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

  import {
    getFirestore,
    doc,
    getDoc
  } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

  // Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyBS5eGv77GcOHL7Z02sGETCaj4YNz6H3uE",
    authDomain: "emagreca-com-saude-4528d.firebaseapp.com",
    projectId: "emagreca-com-saude-4528d",
    storageBucket: "emagreca-com-saude-4528d.firebasestorage.app",
    messagingSenderId: "373054047338",
    appId: "1:373054047338:web:f7aa9db304a04a6877f613",
    measurementId: "G-S5HPSPH3ZX"
  };

  // Inicializa Firebase
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db   = getFirestore(app);

  // ====== IMPORTANTE: mesma fun√ß√£o do backend ======
  // transforma email em ID seguro pro Firestore
  function emailToUserId(email) {
    return email.replace(/[^a-zA-Z0-9._-]/g, "_").toLowerCase();
  }
  // =================================================

  // DOM refs
  const telaLoginEl        = document.getElementById("telaLogin");
  const telaAppEl          = document.getElementById("telaApp");

  const loginStatusEl      = document.getElementById("loginStatus");
  const loginStatusAppEl   = document.getElementById("loginStatusApp");

  const emailLoginEl       = document.getElementById("emailLogin");
  const senhaLoginEl       = document.getElementById("senhaLogin");

  const btnCadastrarEl     = document.getElementById("btnCadastrar");
  const btnLoginEl         = document.getElementById("btnLogin");
  const btnLogoutEl        = document.getElementById("btnLogout");

  const sexoEl             = document.getElementById("sexo");
  const idadeEl            = document.getElementById("idade");
  const pesoEl             = document.getElementById("peso");
  const alturaEl           = document.getElementById("altura");
  const atividadeEl        = document.getElementById("atividade");
  const calcBtn            = document.getElementById("calcBtn");

  const resultadoArea      = document.getElementById("resultadoArea");
  const imcValorEl         = document.getElementById("imcValor");
  const imcClassificacaoEl = document.getElementById("imcClassificacao");
  const kcalManutencaoEl   = document.getElementById("kcalManutencao");
  const kcalCorteEl        = document.getElementById("kcalCorte");
  const kcalSuperavitEl    = document.getElementById("kcalSuperavit");
  const resumoMensagemEl   = document.getElementById("resumoMensagem");

  const dietaBtnEl         = document.getElementById("dietaBtn");

  const paywallModalEl     = document.getElementById("paywallModal");
  const btnFecharModalEl   = document.getElementById("btnFecharModal");

  // Estado
  let USER_LOGADO = false;
  let PREMIUM_LIBERADO = false;

  // Utils de UI
  function abrirPaywall() {
    paywallModalEl.style.display = "flex";
  }

  function fecharPaywall() {
    paywallModalEl.style.display = "none";
  }

  btnFecharModalEl.addEventListener("click", fecharPaywall);

  function trocarTela(logado) {
    telaLoginEl.style.display = logado ? "none" : "block";
    telaAppEl.style.display   = logado ? "block" : "none";
  }

  function classificarIMC(imc) {
    if (imc < 18.5) return "Abaixo";
    else if (imc < 24.9) return "Normal";
    else if (imc < 29.9) return "Sobrepeso";
    else if (imc < 34.9) return "Obesidade I";
    else if (imc < 39.9) return "Obesidade II";
    else return "Obesidade III";
  }

  function calcularTMB(sexo, peso, alturaCm, idade) {
    // F√≥rmula de Mifflin-St Jeor
    if (sexo === "masc") {
      return 10 * peso + 6.25 * alturaCm - 5 * idade + 5;
    } else {
      return 10 * peso + 6.25 * alturaCm - 5 * idade - 161;
    }
  }

  function atualizarBotaoDieta() {
    dietaBtnEl.disabled = false;

    if (!USER_LOGADO) {
      dietaBtnEl.textContent = "üîí Fa√ßa login";
      return;
    }

    if (PREMIUM_LIBERADO) {
      dietaBtnEl.textContent = "üî• Gere agora sua dieta";
    } else {
      dietaBtnEl.textContent = "üí≥ Desbloquear dieta (premium)";
    }
  }

  // Observa login/logout + checa premium usando EMAIL (mesma l√≥gica do backend)
  onAuthStateChanged(auth, async (user) => {
    if (user) {
      USER_LOGADO = true;

      // Atualiza status visual
      loginStatusEl.textContent = "Logado: " + user.email;
      loginStatusEl.classList.remove("status-off");
      loginStatusEl.classList.add("status-ok");

      loginStatusAppEl.textContent = "Logado: " + user.email;
      loginStatusAppEl.classList.remove("status-off");
      loginStatusAppEl.classList.add("status-ok");

      trocarTela(true);

      // üî• AQUI √â A M√ÅGICA: buscar o doc "usuarios/<email-formatado>"
      try {
        const userIdFromEmail = emailToUserId(user.email);
        const snap = await getDoc(doc(db, "usuarios", userIdFromEmail));

        PREMIUM_LIBERADO = snap.exists() && snap.data().premium === true;

        if (PREMIUM_LIBERADO) {
          console.log("‚úÖ Usu√°rio premium liberado:", user.email);
        } else {
          console.log("‚ö†Ô∏è Usu√°rio comum (sem premium):", user.email);
        }
      } catch (e) {
        console.error("Erro lendo Firestore:", e);
        PREMIUM_LIBERADO = false;
      }

      atualizarBotaoDieta();

    } else {
      // Saiu da conta
      USER_LOGADO = false;
      PREMIUM_LIBERADO = false;

      loginStatusEl.textContent = "Desconectado";
      loginStatusEl.classList.remove("status-ok");
      loginStatusEl.classList.add("status-off");

      loginStatusAppEl.textContent = "Desconectado";
      loginStatusAppEl.classList.remove("status-ok");
      loginStatusAppEl.classList.add("status-off");

      trocarTela(false);
      atualizarBotaoDieta();
    }
  });

  // Criar conta
  btnCadastrarEl.addEventListener("click", async () => {
    try {
      await createUserWithEmailAndPassword(auth, emailLoginEl.value, senhaLoginEl.value);
      alert("Conta criada com sucesso ‚úÖ");
    } catch (err) {
      alert("Erro ao cadastrar: " + err.message);
    }
  });

  // Login
  btnLoginEl.addEventListener("click", async () => {
    try {
      await signInWithEmailAndPassword(auth, emailLoginEl.value, senhaLoginEl.value);
      alert("Login feito ‚úÖ");
    } catch (err) {
      alert("Erro ao entrar: " + err.message);
    }
  });

  // Logout
  btnLogoutEl.addEventListener("click", async () => {
    await signOut(auth);
    alert("Saiu da conta");
  });

  // Calcular IMC e kcal
  calcBtn.addEventListener("click", () => {
    const sexo       = sexoEl.value;
    const idade      = parseInt(idadeEl.value);
    const peso       = parseFloat(pesoEl.value);
    const alturaCm   = parseFloat(alturaEl.value);
    const atividade  = parseFloat(atividadeEl.value);

    if (!sexo || !idade || !peso || !alturaCm || !atividade) {
      alert("Por favor, preencha todos os campos corretamente!");
      return;
    }

    const alturaM = alturaCm / 100;
    const imc = peso / (alturaM * alturaM);
    const classificacao = classificarIMC(imc);

    const tmb = calcularTMB(sexo, peso, alturaCm, idade);
    const gastoManutencao = tmb * atividade;
    const cortar500 = gastoManutencao - 500;
    const aumentar500 = gastoManutencao + 500;

    imcValorEl.textContent           = imc.toFixed(2);
    imcClassificacaoEl.textContent   = classificacao;
    kcalManutencaoEl.textContent     = Math.round(gastoManutencao) + " kcal/dia";
    kcalCorteEl.textContent          = Math.round(cortar500) + " kcal/dia";
    kcalSuperavitEl.textContent      = Math.round(aumentar500) + " kcal/dia";

    let msg = "";
    if (classificacao.includes("Obesidade") || classificacao.includes("Sobrepeso")) {
      msg = "üî• D√©ficit de ~500 kcal/dia acelera perda de peso de forma segura.";
    } else if (classificacao.includes("Abaixo")) {
      msg = "üçΩÔ∏è Super√°vit leve ajuda a recuperar massa e energia.";
    } else {
      msg = "‚úÖ Mantenha consist√™ncia e ajuste leve de calorias.";
    }
    resumoMensagemEl.textContent = msg;

    resultadoArea.style.display = "block";

    // salva metas no sessionStorage pra montar dieta depois
    sessionStorage.setItem("nutriMaintKcal", Math.round(gastoManutencao));
    sessionStorage.setItem("nutriCutKcal", Math.round(cortar500));
    sessionStorage.setItem("nutriBulkKcal", Math.round(aumentar500));

    // sugerir objetivo autom√°tico
    let objetivoSugerido = "manutencao";
    if (classificacao.includes("Obesidade") || classificacao.includes("Sobrepeso")) {
      objetivoSugerido = "perda";
    } else if (classificacao.includes("Abaixo")) {
      objetivoSugerido = "ganho";
    }
    sessionStorage.setItem("nutriGoal", objetivoSugerido);
  });

  // Bot√£o "Gerar dieta"
  dietaBtnEl.addEventListener("click", () => {
    if (!USER_LOGADO) {
      alert("Fa√ßa login primeiro para continuar üôå");
      return;
    }

    if (!PREMIUM_LIBERADO) {
      // n√£o premium -> abre modal pagamento
      abrirPaywall();
      return;
    }

    // premium liberado -> manda pra dieta.html com os par√¢metros
    const sugerido = sessionStorage.getItem("nutriGoal") || "manutencao";

    const cutKcal   = sessionStorage.getItem("nutriCutKcal");
    const bulkKcal  = sessionStorage.getItem("nutriBulkKcal");
    const maintKcal = sessionStorage.getItem("nutriMaintKcal");

    let kcalParaMostrar = maintKcal;
    if (sugerido === "perda") kcalParaMostrar = cutKcal;
    if (sugerido === "ganho") kcalParaMostrar = bulkKcal;

    sessionStorage.setItem("nutriTargetKcal", kcalParaMostrar);

    const params = new URLSearchParams({
      goal: sugerido,
      targetKcal: kcalParaMostrar
    });

    window.location.href = "dieta.html?" + params.toString();
  });

</script>
